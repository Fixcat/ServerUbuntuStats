#!/bin/bash

# Цвета для вывода
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Функция для отображения заголовка
print_header() {
    echo -e "${CYAN}╔════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}          ${YELLOW}СТАТИСТИКА СИСТЕМЫ - $(date '+%Y-%m-%d %H:%M:%S')${NC}          ${CYAN}║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

# 1. Загрузка процессора
show_cpu_usage() {
    echo -e "${GREEN}[1] Загрузка процессора:${NC}"
    cpu_usage=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}')
    cpu_cores=$(nproc)
    echo -e "   Использование: ${YELLOW}${cpu_usage}${NC}"
    echo -e "   Ядер процессора: ${YELLOW}${cpu_cores}${NC}"
    echo -e "   Модель: ${YELLOW}$(lscpu | grep "Model name" | cut -d':' -f2 | xargs)${NC}"
    echo ""
}

# 2. Использование оперативной памяти
show_memory_usage() {
    echo -e "${GREEN}[2] Оперативная память:${NC}"
    mem_info=$(free -h | grep Mem)
    total=$(echo $mem_info | awk '{print $2}')
    used=$(echo $mem_info | awk '{print $3}')
    free=$(echo $mem_info | awk '{print $4}')
    percent=$(free | grep Mem | awk '{printf("%.1f"), $3/$2 * 100.0}')
    
    echo -e "   Всего: ${YELLOW}${total}${NC} | Использовано: ${YELLOW}${used}${NC} (${percent}%) | Свободно: ${YELLOW}${free}${NC}"
    
    # Swap
    swap_info=$(free -h | grep Swap)
    swap_total=$(echo $swap_info | awk '{print $2}')
    swap_used=$(echo $swap_info | awk '{print $3}')
    echo -e "   Swap: ${YELLOW}${swap_used}${NC} / ${YELLOW}${swap_total}${NC}"
    echo ""
}

# 3. Использование дисков
show_disk_usage() {
    echo -e "${GREEN}[3] Использование дисков:${NC}"
    df -h | grep -E '^/dev/' | awk '{printf "   %-20s %8s %8s %8s %6s %s\n", $1, $2, $3, $4, $5, $6}'
    echo ""
}

# 4. Сетевая активность
show_network_stats() {
    echo -e "${GREEN}[4] Сетевая активность:${NC}"
    for interface in $(ls /sys/class/net/ | grep -v lo); do
        if [ -d "/sys/class/net/$interface/statistics" ]; then
            rx_bytes=$(cat /sys/class/net/$interface/statistics/rx_bytes)
            tx_bytes=$(cat /sys/class/net/$interface/statistics/tx_bytes)
            rx_mb=$(echo "scale=2; $rx_bytes/1024/1024" | bc)
            tx_mb=$(echo "scale=2; $tx_bytes/1024/1024" | bc)
            echo -e "   ${YELLOW}${interface}${NC}: ↓ ${rx_mb} MB | ↑ ${tx_mb} MB"
        fi
    done
    echo ""
}

# 5. Топ процессов по CPU
show_top_cpu_processes() {
    echo -e "${GREEN}[5] Топ-5 процессов по CPU:${NC}"
    ps aux --sort=-%cpu | head -6 | tail -5 | awk '{printf "   %-8s %6s%% %6s%% %-30s\n", $2, $3, $4, $11}'
    echo ""
}

# 6. Топ процессов по памяти
show_top_memory_processes() {
    echo -e "${GREEN}[6] Топ-5 процессов по памяти:${NC}"
    ps aux --sort=-%mem | head -6 | tail -5 | awk '{printf "   %-8s %6s%% %6s%% %-30s\n", $2, $3, $4, $11}'
    echo ""
}

# 7. Время работы системы и средняя нагрузка
show_uptime() {
    echo -e "${GREEN}[7] Время работы системы:${NC}"
    uptime_info=$(uptime -p)
    load_avg=$(uptime | awk -F'load average:' '{print $2}')
    echo -e "   ${YELLOW}${uptime_info}${NC}"
    echo -e "   Средняя нагрузка:${YELLOW}${load_avg}${NC}"
    echo ""
}

# 8. Информация о пользователях
show_users() {
    echo -e "${GREEN}[8] Активные пользователи:${NC}"
    users_count=$(who | wc -l)
    echo -e "   Подключено пользователей: ${YELLOW}${users_count}${NC}"
    who | awk '{printf "   %-15s %-10s %s\n", $1, $2, $3" "$4}'
    echo ""
}

# 9. Температура системы
show_temperature() {
    echo -e "${GREEN}[9] Температура системы:${NC}"
    if command -v sensors &> /dev/null; then
        sensors | grep -E "Core|temp" | head -5
    else
        echo -e "   ${RED}sensors не установлен. Установите: sudo apt install lm-sensors${NC}"
    fi
    echo ""
}

# 10. Использование портов
show_ports() {
    echo -e "${GREEN}[10] Открытые порты (топ-10):${NC}"
    if command -v ss &> /dev/null; then
        ss -tuln | grep LISTEN | head -10 | awk '{printf "   %-8s %-25s\n", $1, $5}'
    else
        netstat -tuln | grep LISTEN | head -10 | awk '{printf "   %-8s %-25s\n", $1, $4}'
    fi
    echo ""
}

# 11. Информация о батарее (для ноутбуков)
show_battery() {
    echo -e "${GREEN}[11] Состояние батареи:${NC}"
    if [ -d "/sys/class/power_supply/BAT0" ]; then
        battery_status=$(cat /sys/class/power_supply/BAT0/status 2>/dev/null)
        battery_capacity=$(cat /sys/class/power_supply/BAT0/capacity 2>/dev/null)
        echo -e "   Статус: ${YELLOW}${battery_status}${NC} | Заряд: ${YELLOW}${battery_capacity}%${NC}"
    else
        echo -e "   ${YELLOW}Батарея не обнаружена (настольный ПК)${NC}"
    fi
    echo ""
}

# 12. Информация о Docker контейнерах
show_docker() {
    echo -e "${GREEN}[12] Docker контейнеры:${NC}"
    if command -v docker &> /dev/null; then
        running=$(docker ps -q 2>/dev/null | wc -l)
        total=$(docker ps -a -q 2>/dev/null | wc -l)
        echo -e "   Запущено: ${YELLOW}${running}${NC} | Всего: ${YELLOW}${total}${NC}"
        if [ $running -gt 0 ]; then
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | head -6
        fi
    else
        echo -e "   ${YELLOW}Docker не установлен${NC}"
    fi
    echo ""
}

# 13. Последние системные логи
show_logs() {
    echo -e "${GREEN}[13] Последние системные события:${NC}"
    if command -v journalctl &> /dev/null; then
        journalctl -p err -n 5 --no-pager 2>/dev/null | tail -5
    else
        tail -5 /var/log/syslog 2>/dev/null || echo -e "   ${YELLOW}Логи недоступны${NC}"
    fi
    echo ""
}

# 14. Информация о файловой системе
show_filesystem_info() {
    echo -e "${GREEN}[14] Информация о файловой системе:${NC}"
    echo -e "   Inodes использовано:"
    df -i | grep -E '^/dev/' | awk '{printf "   %-20s %10s %10s %6s\n", $1, $3, $4, $5}' | head -3
    echo ""
}

# Основная функция
main() {
    clear
    print_header
    
    show_cpu_usage
    show_memory_usage
    show_disk_usage
    show_network_stats
    show_top_cpu_processes
    show_top_memory_processes
    show_uptime
    show_users
    show_temperature
    show_ports
    show_battery
    show_docker
    show_logs
    show_filesystem_info
    
    echo -e "${CYAN}╔════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}  Для обновления запустите команду снова: ${YELLOW}stats${NC}              ${CYAN}║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════════════════════════════╝${NC}"
}

# Запуск программы
main
